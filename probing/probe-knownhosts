#!/bin/sh

n=$(ls -1 knownhosts/ | wc | awk '{print $1}')
i=1

while [ $i -le $n ]
do
	domain=$(ls -1 knownhosts/ | sed "${i}q;d")
	Mi=$(wc knownhosts/$domain | awk '{print $1}')
	j=1

	while [ $j -le $Mi ]
	do
		echo -ne "$j of $Mi in $domain ($i of $n domains)\r"
		server=$(curl -I -s --connect-timeout 2 "$(sed "${j}q;d" knownhosts/$domain)" | grep Server | sed "s/Server:\s//g")
		if [ -z "$server" ]; then
			server=$(curl -I -s --connect-timeout 2 "https://$(sed "${j}q;d" knownhosts/$domain)" | grep Server | sed "s/Server:\s//g")
			if [ -z "$server" ]; then
				server=$(curl -I -s --connect-timeout 2 "http://$(sed "${j}q;d" knownhosts/$domain)" | grep Server | sed "s/Server:\s//g")
				if [ -z "$server" ]; then
					echo "NA" >> servers/$domain
				else
					echo $server >> servers/$domain
				fi
			else
				echo $server >> servers/$domain
			fi
		else
			echo $server >> servers/$domain
		fi
		j=$((++j))
	done

	i=$((++i))
done
